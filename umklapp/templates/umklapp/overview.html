{% extends request.is_ajax|yesno:"umklapp/base_ajax.html,umklapp/base.html"%}
{% load bootstrap %}
{% block title %}Das Umklappspiel{% endblock %}

{% block pretitle %}{% if action_count %}({{action_count}}) {% endif %}{% endblock %}

{% block content %}
<div class="container">

<h2>Laufende Geschichten</h2>
{% if running_stories %}

  <div>
  <table class="table">
   <thead>
    <tr>
     <th class="expand"></th>
     <th class="text-right" title="Anzahl Sätze in der Geschichte">
     <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span></th>
     <th class="text-right" title="Anzahl Mitspieler">
      <span class="glyphicon glyphicon-user" aria-hidden="true"></span></th>
     <th class="text-left" title="Aktueller Spieler">
      <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></th>
    </tr>
   </thead>
   <tbody>
    {% for s in running_stories %}
     <tr {% if s.waiting_for = user %} class="actionable" {% endif %}>
      <td class="ellipsis"><a class="tablelink" href="{% url 'show_story' story_id=s.id %}">{{ s.title }}</a></td>
      <td class="text-right">{{ s.parts_count }}</td>
      <td class="text-right">{{ s.active_count }}</td>
      <td class="text-left">{{ s.waiting_for }}</td>
     </tr>
   {% endfor %}
   </tbody>
  </table>
  </div>

{% else %}

<p>Es gibt gerade keine laufenden Geschichten.
Du könntest eine <a href="{% url 'new_story' %}">neue Geschichte starten</a>.
<a href="{% url 'new_story' %}">Klick hier</a>!</p>

{% endif %}

<h2>Willst Du eine <a href="{% url 'new_story' %}">neue Geschichte starten</a>?</h2>
</div>

<div class="container">
<div class="row">
<div class="col-md-6">
<h2>Beendete Geschichten </h2>
{% if finished_stories %}
  <table class="table">
   <thead>
    <tr>
     <th class="expand"></th>
     <th class="text-right" title="Anzahl Sätze in der Geschichte">
      <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span></th>
     <th class="text-right" title="Anzahl Mitspieler">
      <span class="glyphicon glyphicon-user" aria-hidden="true"></span></th>
     <th class="text-right" title="Leseempfehlungen">
      <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></th>
    </tr>
   </thead>
   <tbody>
    {% for s in finished_stories %}
    <tr {% if s in new_stories %} class="actionable" {% endif %}>
      <td class="ellipsis"><a class="tablelink" href="{% url 'show_story' story_id=s.id %}">{{ s.title }}</a></td>
      <td class="text-right">{{ s.parts_count }}</td>
      <td class="text-right">{{ s.contrib_count}}</td>
      <td class="text-right">{{ s.upvote_count|default:"" }}</td>
     </tr>
   {% endfor %}
   </tbody>
  </table>
{% else %}
<p>Es gibt gerade keine fertigen Geschichten.</p>
{% endif %}
</div>

<div class="col-md-6">
{% if user_activity %}
<h2>Die fleißigsten Erzähler</h2>
<table class="table">
 <thead>
  <tr>
   <th title="Platzierung">#</th>
   <th class="expand" title="Spielername">
    <span class="glyphicon glyphicon-user" aria-hidden="true"></span></th>
   <th title="Anzahl geschriebener Sätze">
    <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span></th>
  </tr>
 </thead>
 <tbody>
  {% for u in user_activity %}
   <tr>
    <td>{% ifchanged u.parts_written %}{{ forloop.counter }}{% endifchanged %}</td>
    <td>{{ u.username }}</td>
    <td class="text-right">{{ u.parts_written }}</td>
   </tr>
  {% endfor %}
 </tbody>
</table>
{% endif %}
</div>
</div>
</div>
{% endblock %}

{% block pageend %}
<script>
/*  http://stackoverflow.com/a/13324909/946226 */
$(function() {
    setInterval(startRefresh,20*1000);
});

function startRefresh() {
    $.get('/ajax', function(data) {
        $('#content').html(data);
	if ($('#settitle')) {
	    $('title').text($('#settitle').text());
	    $('#settitle').remove();
	}
    });
}
</script>
{% endblock %}

